<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Экспертная система</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1><i class="fas fa-leaf"></i> Экспертная система</h1>
    <div class="result-container" id="crop-selection">
        <label for="crop">Выберите культуру:</label>
        <select id="crop" required>
            <option value="подсолнечник">Подсолнечник</option>
            <option value="рапс">Рапс</option>
            <option value="соя">Соя</option>
        </select>
        <button onclick="startQuestions()" class="submit-icon">Продолжить <i class="fas fa-arrow-right"></i></button>
    </div>

    <div class="result-container" id="questions" style="display: none;">
        <h2>Вопросы диагностики</h2>
        <div id="current-question"></div>
        <button class="yes-btn" onclick="answerQuestion('yes')">Да</button>
        <button class="no-btn" onclick="answerQuestion('no')">Нет</button>
        <p>Вопрос <span id="question-number">1</span> из <span id="total-questions"></span></p>
    </div>

    <div class="result-container" id="results" style="display: none;">
        <h2>Результат диагностики</h2>
        <p><strong>Культура:</strong> <span id="result-crop"></span></p>
        <p><strong>Подтверждённые симптомы:</strong> <span id="result-symptoms"></span></p>
        <p><strong>Диагноз:</strong> <span id="result-diagnosis"></span></p>
        <div class="chart-container">
            <canvas id="probability-chart"></canvas>
        </div>
        <a href="#" onclick="restart()"><i class="fas fa-arrow-left"></i> Начать заново</a>
    </div>

    <script>
        let selectedCrop = '';
        let currentQuestionIndex = 0;
        let yesAnswers = new Set();
        let questions = [];
        const diseaseMap = {
            'подсолнечник': {
                'тля': ['желтые пятна', 'скручивание листьев'],
                'подсолнечниковая огневка': ['поврежденные семена', 'личинки в корзинках'],
                'альтернариоз': ['темные пятна на листьях', 'желтый ореол'],
                'склеротиниоз': ['мягкие гниющие пятна', 'белый налет']
            },
            'рапс': {
                'капустная совка': ['отверстия в листьях', 'гусеницы'],
                'рапсовый цветоед': ['поврежденные бутоны', 'наличие жуков'],
                'белая гниль': ['белый налет на стеблях', 'увядание растений'],
                'рапсовый пилильщик': ['объеденные листья', 'личинки с черной головой']
            },
            'соя': {
                'стеблевой долгоносик': ['поврежденные стебли', 'личинки внутри'],
                'фитофтороз': ['бурые пятна на листьях', 'увядание растений'],
                'паутинный клещ': ['мелкие желтые пятна', 'паутина'],
                'аскохитоз': ['серо-белые пятна', 'черные точки']
            }
        };

        const diagnosisMap = {
            'подсолнечник': {
                'тля': 'Вредитель: тля\nРекомендация: опрыскивание имидаклопридом в период вегетации.',
                'подсолнечниковая огневка': 'Вредитель: подсолнечниковая огневка\nРекомендация: опрыскивание дельтаметрином в начале цветения.',
                'альтернариоз': 'Болезнь: альтернариоз\nРекомендация: опрыскивание азоксистробином.',
                'склеротиниоз': 'Болезнь: склеротиниоз\nРекомендация: обработка тебуконазолом и удаление пораженных частей.'
            },
            'рапс': {
                'капустная совка': 'Вредитель: капустная совка\nРекомендация: опрыскивание Bacillus thuringiensis.',
                'рапсовый цветоед': 'Вредитель: рапсовый цветоед\nРекомендация: опрыскивание тиаклопридом до начала цветения.',
                'белая гниль': 'Болезнь: белая гниль\nРекомендация: обработка боскалидом и удаление пораженных растений.',
                'рапсовый пилильщик': 'Вредитель: рапсовый пилильщик\nРекомендация: опрыскивание лямбда-цигалотрином в период активности личинок.'
            },
            'соя': {
                'стеблевой долгоносик': 'Вредитель: стеблевой долгоносик\nРекомендация: опрыскивание хлорпирифосом + севооборот.',
                'фитофтороз': 'Болезнь: фитофтороз\nРекомендация: обработка металаксилом и севооборот.',
                'паутинный клещ': 'Вредитель: паутинный клещ\nРекомендация: опрыскивание абамектином.',
                'аскохитоз': 'Болезнь: аскохитоз\nРекомендация: обработка хлороталонилом и соблюдение севооборота.'
            }
        };

        function startQuestions() {
            selectedCrop = document.getElementById('crop').value;
            questions = [];
            const diseases = diseaseMap[selectedCrop];
            for (const disease in diseases) {
                for (const symptom of diseases[disease]) {
                    questions.push({ question: `У ${selectedCrop} имеются ${symptom}?`, symptom });
                }
            }
            questions = [...new Map(questions.map(item => [item.symptom, item])).values()]; // Удаляем дубликаты
            currentQuestionIndex = 0;
            yesAnswers.clear();
            document.getElementById('crop-selection').style.display = 'none';
            document.getElementById('questions').style.display = 'block';
            document.getElementById('total-questions').textContent = questions.length;
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex < questions.length) {
                document.getElementById('current-question').textContent = questions[currentQuestionIndex].question;
                document.getElementById('question-number').textContent = currentQuestionIndex + 1;
            } else {
                showResults();
            }
        }

        function answerQuestion(answer) {
            if (answer === 'yes') {
                yesAnswers.add(questions[currentQuestionIndex].symptom);
            }
            currentQuestionIndex++;
            showQuestion();
        }

        function calculateProbabilities() {
            const diseases = diseaseMap[selectedCrop];
            const probabilities = {};
            let totalMatches = 0;

            for (const disease in diseases) {
                const matches = diseases[disease].filter(symptom => yesAnswers.has(symptom)).length;
                probabilities[disease] = matches;
                totalMatches += matches;
            }

            if (totalMatches > 0) {
                for (const disease in probabilities) {
                    probabilities[disease] = (probabilities[disease] / totalMatches) * 100;
                    if (probabilities[disease] === 100) {
                        probabilities[disease] = 99;
                    }
                    probabilities[disease] = Math.round(probabilities[disease] * 100) / 100;
                }
            } else {
                const numDiseases = Object.keys(diseases).length;
                const baseProbability = Math.round((100 / numDiseases) * 100) / 100;
                for (const disease in probabilities) {
                    probabilities[disease] = baseProbability;
                }
            }
            return probabilities;
        }

        function getDiagnosis(probabilities) {
            let maxProb = 0;
            let likelyDisease = null;
            for (const disease in probabilities) {
                if (probabilities[disease] > maxProb) {
                    maxProb = probabilities[disease];
                    likelyDisease = disease;
                }
            }
            return likelyDisease ? diagnosisMap[selectedCrop][likelyDisease] : "Диагноз не определён. Проверьте, соответствуют ли симптомы одному из правил.";
        }

        function showResults() {
            document.getElementById('questions').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            document.getElementById('result-crop').textContent = selectedCrop;
            document.getElementById('result-symptoms').textContent = yesAnswers.size > 0 ? Array.from(yesAnswers).join(', ') : 'Нет подтверждённых симптомов';
            
            const probabilities = calculateProbabilities();
            const diagnosis = getDiagnosis(probabilities);
            document.getElementById('result-diagnosis').textContent = diagnosis;

            const filteredProbabilities = Object.fromEntries(
                Object.entries(probabilities).filter(([_, prob]) => prob > 0)
            );
            const labels = Object.keys(filteredProbabilities);
            const data = Object.values(filteredProbabilities);
            const ctx = document.getElementById('probability-chart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function restart() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('crop-selection').style.display = 'block';
            currentQuestionIndex = 0;
            yesAnswers.clear();
            questions = [];
        }
    </script>
</body>
</html>